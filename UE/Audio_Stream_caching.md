## Audio stream caching

Audio Stream Caching은 Unreal Engine에서 오디오 성능을 최적화하기 위한 기능

#### 주요 특징

* 메모리 최적화: 전체 오디오 파일을 메모리에 로드하는 대신 필요한 부분만 캐시에 저장
* 스트리밍 성능 향상: 자주 사용되는 오디오 데이터를 캐시에 유지하여 디스크 액세스를 줄입니다.

#### 어떻게 동작하는가?

* When this feature is enabled at cook time, almost all compressed audio data is separated from the USoundWave asset and placed at the end of the .pak file. This makes it possible for audio to be loaded into memory at any point, and released again when it has not been recently used.


#### 장점

* 전체 오디오 파일 로드 X -> 메모리 사용량 감소
* 전체 오디오 파일 로드 X -> 로딩 시간 단축
* 대용량 오디오 파일 처리 효율 증가

#### 단점
* SoundWave가 로드되었다고, 오디오가 즉시 재생 가능하다고 보장 X -> 재생이 재연될 수 있음.
* 스트리밍 오버헤드 -> 재생 중 지속적인 데이터 로딩 -> CPU 연산 증가
* 디스크 I/O: 디스크 성능 중요성 커짐

#### 주의사항
* 캐시 크기 설정에 따라 성능이 좌지우지됨 -> 적절한 사이즈를 결정해야함.
* 재생 지연은 캐시 크기에 따라 관련이 있을 확률이 높음


#### 사운드 로드 후 맵에 저장 vs 오디오 스트림 캐싱 사용

* 사운드 로드 후 맵에 저장하는 방식은 모든 오디오 데이터가 메모리에 상주
* 오디오 스트림 캐싱 사용을 하고 맵에 저장하는 방식은 오디오 파일에 대한 참조와 메타데이터 저장

#### 맵에 저장한다는 것과 메모리에 올리는 것의 차이

* 맵에 저장한다는 것이 반드시 전체 데이터를 메모리에 올린다는 의미X
* 오디오 스트림 캐싱을 사용할 때, TMap에 저장되는 것은 주로 오디오 파일에 대한 참조와 메타데이터임
* 실제 오디오 데이터는 디스크에 남아있고, 필요한 부분만 작은 청크(chunk) 단위로 캐시에 로드됨
  

#### 메모리 사용량이 줄어드는 이유
* 스트림 캐싱을 사용하면, 대부분의 오디오 데이터는 디스크에 남아있음
* 메인 메모리에는 작은 캐시와 오디오 파일 참조만 존재함


#### Audio Stream Caching을 사용 시 로드의 의미 변화


* 초기 로드 과정
  * 오디오 파일의 메타데이터와 스트리밍에 필요한 정보를 로드

* 캐시프라이밍 - 오디오 데이터 일부를 메모리에 로드
  * 재생을 빠르게 시작 -> 재생 지연 낮춤
  * Prime On Load 옵션 사용

* 스트리밍 준비
  * 실제 오디오 데이터의 위치와 접근 방법에 대한 정보를 설정

* 런타임 로딩
  * 오디오 재생 시, 필요한 부분을 그때그때 캐시로 로드
  * 백그라운드에서 비동기적으로 이뤄짐


전통적인 방식: 전체 오디오 파일을 한 번에 메모리에 로드

스트림 캐싱 방식: 메타데이터와 초기 캐시 데이터만 로드하고, 나머지는 필요할 때 스트리밍


#### ESoundWaveLoadingBehavior: enum

1. Inherited: 
   * 기본 설정
   * 사운드 클래스나 전역 설정에서 로딩 동작을 상속

2. RetainOnLoad:
   * 사운드 전체를 메모리에 로드하고 유지
   * 작고 자주 사용되는 사운드에 적합 (예: UI 효과음, 짧은 캐릭터 음성)
   * 장점: 빠른 재생 시작, 지연 없음.
   * 단점: 메모리 사용량 증가.

3. PrimeOnLoad:
   * 사운드의 시작 부분만 메모리에 로드
   * 큰 사운드 파일의 빠른 초기 재생이 필요할 때 유용
   * 장점: 빠른 초기 재생, 상대적으로 적은 메모리 사용.
   * 단점: 전체 사운드가 필요할 때 추가 로딩 시간 발생 가능

4. LoadOnDemand:
   * 필요할 때만 사운드 데이터를 로드
   * 큰 사운드 파일이나 자주 사용되지 않는 사운드에 적합
   * 장점: 메모리 사용 최소화.
   * 단점: 초기 재생 시 약간의 지연 발생 가능.

5. ForceInline:
   * 사운드를 스트리밍 가능한 에셋 패키지에 강제로 인라인화
   * 특수한 경우에 사용됨(예: 패키징 요구사항이 특별한 경우).


* 사용시 고려사항
  * 게임의 메모리 제약: 모바일 게임의 경우 LoadOnDemand나 PrimeOnLoad가 유용할 수 있음
  * 사운드의 크기와 사용 빈도: 작고 자주 사용되는 사운드는 RetainOnLoad, 큰 배경음악은 LoadOnDemand가 적합
  * 초기 로딩 시간 vs 런타임 성능: RetainOnLoad는 초기 로딩 시간을 증가시키지만 런타임 성능이 좋음

* 실제 적용 예시:

  * UI 효과음: RetainOnLoad (빠른 반응성 필요)
  * 배경 음악: LoadOnDemand 또는 PrimeOnLoad (파일 크기가 크지만 즉각적인 재생 시작이 필요하지 않을 수 있음)
  * 레벨별 특수 효과음: LoadOnDemand (필요할 때만 로드)
  * 자주 사용되는 캐릭터 음성: RetainOnLoad 또는 PrimeOnLoad (반응성과 메모리 사용의 균형)


