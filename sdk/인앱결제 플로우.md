### iOS IAP

1. 앱스토어 커넥트에서 상품 등록 (product id, 소모성, 갱신형 etc...)
2. product id로 상품 정보 요청
3. 사용자 결제 요청
4. Apple 결제 처리 및 영수증 생성
5. 결제 결과 처리
6. 클라이언트는 기본적인 영수증 검증을 하기
	1. 영수증 여부 검사 (데이터 존재 유무)
	2. 앱 무결성 (앱 번들 아이디를 확인한다든지 등.)
	3. 거래 정보 기본 확인 (transaction id, prouduct id)

7. 거래 완료 처리 (성공이든, 실패든 일단 transaction은 완료 처리 해야함)
	1. 거래 완료 처리를 안하면 계속 pending 상태로 남아 있게됨. 그러면 중복 결제 가능성 있음
	2. 사용자는 결제를 완료 했는데 결제 프로세스가 실행된다면 유저경험이 매우 떨어진다!!

8. 백엔드로 영수증 보냄 (영수증 검증은 백엔드에서 진행하길 적극 권장)

### 안드로이드 IAP

안드로이드 인앱결제 플로우

1. 구글 결제 서비스 연결 - Start Connection
2. 연결 확인 - IsReady
3. 상품 조회 - QuerySkuDetail
4. 구매시작 - LaunchBillingFlow
5. 구매 후 처리
	*  AcknowledgePurchase - Google에 구매 승인 통지
	*  Consume - 소모성 아이템 소비 처리

6. 상태확인 - QueryPurchases

보통 플로우는 아래처럼 되어야 함.

```
1. [클라이언트] StartConnection() → Google Play 연결
2. [클라이언트] QuerySkuDetails() → 상품 정보 조회  
3. [클라이언트] LaunchBillingFlow() → 사용자 결제 진행
4. [클라이언트] AcknowledgePurchase() → Google에 구매 확인

--- 여기서 백엔드 개입 ---
5. [클라이언트→백엔드] 구매 토큰을 백엔드로 전송
6. [백엔드→Google] 구매 토큰 검증 (Google Play Developer API)
7. [백엔드] 아이템 지급 + DB에 기록
8. [백엔드→클라이언트] 지급 완료 응답

--- 소모성 아이템인 경우만 ---
9. [클라이언트] Consume() → Google Play에서 소비 처리
```


Consume을 해야 사용자가 재구매가 가능함. Consume을 클라이언트에서 호출 하지 않으면 재구매가 불가능하게 됨.


#### 발생할 수 있는 에러

안드로이드 클라이언트에서 발생 가능성 있는 에러 (PlayStore API Error 참고)

```
AndroidBillingResponseCode
{
    // 성공
    Ok = 0,
    
    // 사용자 관련 에러
    UserCancelled = 1,          // 사용자가 취소/뒤로가기
    
    // 서비스 관련 에러  
    ServiceUnavailable = 2,     // 네트워크 연결 끊김
    BillingUnavailable = 3,     // Billing API 버전 미지원
    ServiceTimeout = 97,        // Google Play 응답 시간 초과
    ServiceDisconnected = 99,   // Play Store 서비스 연결 끊김
    
    // 상품 관련 에러
    ItemUnavailable = 4,        // 상품을 구매할 수 없음
    ItemAlreadyOwned = 7,       // 이미 소유한 아이템
    ItemNotOwned = 8,           // 소유하지 않은 아이템 소비 시도
    
    // 개발자 에러
    DeveloperError = 5,         // 잘못된 API 인자 전달
    
    // 기타 에러
    Error = 6,                  // 일반적인 fatal error
    FeatureNotSupported = 98    // 현재 기기에서 미지원 기능
};
```


백엔드 연동 관련 추가될 수 있는 에러들

```
// 백엔드 연동 관련 추가 에러 코드
BackendBillingError
{
    // 백엔드 통신 에러
    BackendConnectionFailed = 200,     // 백엔드 서버 연결 실패
    BackendTimeout = 201,              // 백엔드 응답 시간 초과
    BackendAuthFailed = 202,           // 백엔드 인증 실패
    
    // 구매 검증 에러  
    PurchaseVerificationFailed = 210,  // 구매 토큰 검증 실패
    DuplicatePurchase = 211,           // 중복 구매 시도
    InvalidPurchaseToken = 212,        // 유효하지 않은 구매 토큰
    
    // 아이템 지급 에러
    ItemDeliveryFailed = 220,          // 아이템 지급 실패
    InsufficientInventory = 221,       // 재고 부족
    UserAccountNotFound = 222,         // 사용자 계정 없음
    
    // 소비 처리 에러
    ConsumeTimingError = 230,          // 잘못된 시점의 소비 시도
    ConsumeRetryExceeded = 231,        // 소비 재시도 횟수 초과
};
```



iOS는 사용자 경험을 좀 더 우선시 하는 거 같고, 안드로이드는 부정 구매에 대한 방어에 초점이 맞춰져 있는 거 같다.