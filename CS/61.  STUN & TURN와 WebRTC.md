
클라이언트 1과 클라이언트 2를 연결하는 과정을 가정

클라이언트 1과 클라이언트2는 공유기와 LTE/5G 망에 있어 통신사가 부여한 사설 IP주소만을 알고 있다. 서로의 진짜 위치인 공인 IP를 모르기 때문에 STUN & TURN 서버를 사용한다.

이 경우 서로 연결하기 위한 베스트 과정은 (주로 같은 네트워크)

1. 각 클라이언트는 STUN 서버에게 자신의 공인 IP 주소를 알려달라고 요청한다.
2. STUN 서버는 공인 IP + 포트 번호를 각 클라이언트에게 전달 한다.
3. 두 클라이언트는 시그널링 서버를 통해서 정보를 교환 한다.
4. 두 클라이언트는 서로의 주소를 알았기 때문에 P2P 연결을 한다.
5. STUN 서버는 이제 일 안해도 됨.


개념적으로는 P2P 연결이 실패하면 중계 서버를 이용한다. 이 중계 서버가 TURN 서버로 이해할 수 있다.
다만 실제로는 일단 해보고 실패하면 다시 연결한다보다는 가능한 모든 주소를 한꺼번에 알려주고 가장 좋은 걸 고른다.

예를 들면 세개의 주소 를 시그널링 서버에 보낸다. (Candidate Gathering)

1. Local 주소 (192.168.x.x - Host Candidate) -> 같은 와이파이 아니면 안됨
2. STUN 서버를 이용한 공인 IP 주소 (Server Reflexive Candidate) -> 방화벽으로 안될 가능성
3. TURN 서버 주소 (Relayed Candidate) -> 거의 됨

이 중에 가장 빠른 걸 선택한다

그리고 이러한 STUN에 물어보고, TURN 연결해 보고, 제일 빠른 길 찾아서 연결하는 과정을 WebRTC 엔진이 해주고, 개발자는 시그널링 서버만 구현하면 된다.


### WebRTC

STUN, TURN, ICE, P2P... 이 모든 복잡한 기술들을 한데 묶어서 브라우저에서 쉽게 쓸 수 있게 만든 것이 WebRTC다.

1. 영상/음성 코덱: 마이크와 카메라(혹은 게임 화면) 데이터를 압축(Encoding)하고, 받는 쪽에서 압축을 푸는(Decoding) 기능을 내장하고 있음 (H.264, VP8/9 등)

2. 보안 (Encryption):  모든 데이터는 DTLS/SRTP라는 기술로 강력하게 암호화되어 전송됨

3. 데이터 채널: 영상뿐만 아니라 마우스 클릭, 키보드 입력 같은 일반 데이터도 아주 빠르게 보낼 수 있습니다.